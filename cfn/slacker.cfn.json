{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Lambda function to send messages to Slack",
  "Parameters": {
    "lambdaName": {
      "Description": "Lambda function name",
      "Type": "String",
      "Default": "slacker",
      "MinLength": 1,
      "ConstraintDescription": "Must be specified."
    },
      "lambdaVersion": {
      "Description": "Code version of the lambda bundle (e.g. 2.3.1).",
      "Type": "String",
      "MinLength": 5,
      "ConstraintDescription": "Must be in the form major.minor.patch."
    },
    "lambdaTimeout": {
      "Description": "Timeout for the lambda (seconds)",
      "Type": "Number",
      "Default": 30,
      "MinValue": 15,
      "MaxValue": 900,
      "ConstraintDescription": "Must be between 15 and 900."
    },
    "lambdaMemory": {
      "Description": "Memory for the lambdas (Mb)",
      "Type": "Number",
      "Default": 150,
      "MinValue": 128,
      "ConstraintDescription": "A minimum of 150Mb is recommended."
    },
    "s3CodeBucket": {
      "Description": "S3 bucket containing the Lambda function code bundle.",
      "Type": "String",
      "MinLength": 1
    },
    "s3CodePrefix": {
      "Description": "Prefix in S3 bucket containining lambda code.",
      "Type": "String",
      "MinLength": 1,
      "ConstraintDescription": "Must be specified."
    },
    "defaultSideBarColour": {
      "Description": "Default colour for sidebar on Slack messages (e.g. #ab1234).",
      "Type": "String",
      "Default": "#bbbbbb",
      "AllowedPattern": "^(#\\p{XDigit}{6})|(good)|(warning)|(danger)$",
      "ConstraintDescription": "Must be # followed by 6 hex digits or good, warning or danger."
    },
    "maxMessageLen": {
      "Description": "Maximum length of messages sent to Slack. Longer messages are truncated.",
      "Type": "Number",
      "Default": 4000,
      "MinValue": "1",
      "ConstraintDescription": "Must be a non-negative integer."
    },
    "dynamoDbReadCapacity": {
      "Description": "Read capacity units for the DynamoDB tables.",
      "Type": "Number",
      "Default": 5,
      "MinValue": 1
    },
    "logIncomingMessages": {
      "Description": "Log incoming messages to CloudWatch (0 = No, 1 = Yes)",
      "Type": "Number",
      "AllowedValues": [ 0, 1 ],
      "Default": 0
    }
  },
  "Conditions": {
    "ifLogMessages":  { "Fn::Equals": [ { "Ref": "logIncomingMessages" }, "Yes" ] }
  },
  "Resources": {
    "iamRoleSlacker": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Ref": "AWS::StackName" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "lambda.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "cloudwatchAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogStreams"
                  ],
                  "Resource": [
                    "arn:aws:logs:*:*:*"
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "dynamoSlackerTablesAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "ListTables",
                  "Effect": "Allow",
                  "Action": [ "dynamodb:ListTables" ],
                  "Resource": [ "*" ]
                },
                {
                  "Sid": "ReadAccess",
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:BatchGetItem",
                    "dynamodb:DescribeTable",
                    "dynamodb:GetItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:dynamodb:",
                          { "Ref": "AWS::Region" },
                          ":",
                          { "Ref": "AWS::AccountId" },
                          ":table/",
                          { "Ref": "AWS::StackName" },
                          ".*"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "stsGetIdentity",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": "sts:GetCallerIdentity",
                  "Effect": "Allow",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "lambdaSlacker": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": { "Ref": "AWS::StackName" },
        "Description": "Send AWS event messages to Slack",
        "Architectures": ["arm64"],
        "MemorySize": { "Ref": "lambdaMemory"},
        "Role": { "Fn::GetAtt": [ "iamRoleSlacker", "Arn" ] },
        "Runtime": "python3.13",
        "Handler": { "Fn::Sub": "${lambdaName}.lambda_handler"},
        "Timeout": { "Ref": "lambdaTimeout" },
        "Environment": {
          "Variables": {
            "SLACKER_WEBHOOK_TABLE": { "Fn::Join" : [ ".", [ { "Ref": "AWS::StackName" }, "webhooks" ] ] },
            "SLACKER_CHANNEL_TABLE": { "Fn::Join" : [ ".", [ { "Ref": "AWS::StackName" }, "channels" ] ] },
            "SLACKER_COLOUR": { "Ref": "defaultSideBarColour"},
            "SLACKER_MSG_LEN": { "Ref": "maxMessageLen"},
            "LOG_MESSAGES": { "Ref": "logIncomingMessages"}
          }
        },
        "Code": {
          "S3Bucket": { "Ref": "s3CodeBucket" },
          "S3Key": { "Fn::Sub": "${s3CodePrefix}/${lambdaName}-${lambdaVersion}.zip" }
        }
      }
    },
    "dynWebhooks": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": { "Fn::Join" : [ ".", [ { "Ref": "AWS::StackName" }, "webhooks" ] ] },
        "AttributeDefinitions": [ { "AttributeName": "sourceId", "AttributeType": "S" } ],
        "KeySchema": [ { "AttributeName": "sourceId", "KeyType": "HASH" } ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits" : { "Ref": "dynamoDbReadCapacity"},
          "WriteCapacityUnits" : 1
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        }
      }
    },
    "dynChannels": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": { "Fn::Join" : [ ".", [ { "Ref": "AWS::StackName" }, "channels" ] ] },
        "AttributeDefinitions": [ { "AttributeName": "channel", "AttributeType": "S" } ],
        "KeySchema": [ { "AttributeName": "channel", "KeyType": "HASH" } ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits" : { "Ref": "dynamoDbReadCapacity"},
          "WriteCapacityUnits" : 1
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        }
      }
    }
  }
}
